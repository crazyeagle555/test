---
- name: Install Python-APP
  gather_facts: No
  hosts: 127.0.0.1
  connection: local

  tasks:
  
    - name: Create new group
      group:
        name: test-user
        state: present
    
    - name: Add test_user
      user: 
        name: test_user
        shell: /bin/bash
        groups: www-data
        append: yes        

    - name: Install Python 3.6
      yum:
        name:
          - python36
          - python36-devel
          - python36-pip
          - gcc
          - postgresql-devel
          - python-pip
          - python-devel
        state: present

    - name: clone repo
      git:
        repo: 'https://github.com/mbaran0v/python-sample-app.git'
        dest: /home/test_user/app
        update: yes  # Does a git pull if the repo already exists
        
    - name: Change file ownership, group and permissions
      file:
        path: /home/test_user
        owner: test_user
        group: test-user
        state: directory
        recurse: yes
        mode: '0755'    
        
    - pip:
        requirements: /home/test_user/app/requirements.txt
        executable: pip3.6
    
    - pip:
        name: gunicorn
        executable: pip3.6

    - pip:
        name: psycopg2
        executable: pip

    - name: Create test database
      become: true
      become_user: postgres
      postgresql_db:
        name: test

    - name: Create a PostrgeSQL database user
      become: true
      become_user: postgres 
      postgresql_user:
        db: test
        name: test_user
        password: md59547825b576517549329fbe5eeb199fb
        encrypted: 'yes'
        expires: infinity
        
    - name: Run application
      shell: export FLASK_APP=app.py
             export POSTGRESQL_URL=postgresql://test_user:DMg00LhU@127.0.0.1/app
             flask db upgrade
      args:
        chdir: /home/test_user/app

    - name: Create systemd service
      copy:
        src: .service
        dest: /etc/systemd/system/TestApp.service
    
    - service:
        name: TestApp.service
        state: started
        enabled: yes 
